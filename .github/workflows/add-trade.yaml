name: üöÄ Add Trade Entry

on:
  workflow_dispatch:
    inputs:
      pair:
        description: 'Trading pair (e.g., BTC/USDT)'
        required: true
        type: string
      datetime:
        description: 'Date and time (YYYY-MM-DD HH:mm)'
        required: true
        type: string
      bias:
        description: 'Bias'
        required: true
        type: choice
        options:
          - 'Bullish üìà'
          - 'Bearish üìâ'
      liquidity:
        description: 'Liquidity'
        required: true
        type: string
      poi:
        description: 'Point of Interest'
        required: true
        type: string
      outcome:
        description: 'Outcome'
        required: true
        type: choice
        options:
          - Win ‚úÖ
          - Loss ‚ùå 
          - Break-even üö•
      pl:
        description: 'P/L (e.g., +100, -50, 0)'
        required: true
        type: string
      notes:
        description: 'Notes'
        required: false
        type: string
      confirm:
        description: 'Please confirm all data is correct'
        required: true
        type: boolean

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          repository: 201508876PMH/hkh-trading
          token: ${{ secrets.GH_PAT }}

      - name: Verify confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "true" ]]; then
            echo "You must confirm all data is correct by checking the confirm box."
            exit 1
          fi

      - name: Append new entry
        working-directory: docs/public/data
        run: |
          # Strip emojis from bias
          BIAS="${{ inputs.bias }}"
          BIAS="${BIAS//üìà/}"
          BIAS="${BIAS//üìâ/}"
          BIAS="$(echo "$BIAS" | xargs)"  # Trim whitespace

          # Strip emojis from outcome
          OUTCOME="${{ inputs.outcome }}"
          OUTCOME="${OUTCOME//‚úÖ/}"
          OUTCOME="${OUTCOME//‚ùå/}"
          OUTCOME="${OUTCOME//üö•/}"
          OUTCOME="$(echo "$OUTCOME" | xargs)"  # Trim whitespace

          cat <<EOF >> data.yaml

          - pair: ${{ inputs.pair }}
            datetime: "${{ inputs.datetime }}"
            bias: $BIAS
            liquidity: "${{ inputs.liquidity }}"
            poi: "${{ inputs.poi }}"
            outcome: "$OUTCOME"
            pl: "${{ inputs.pl }}"
            notes: "${{ inputs.notes }}"
          EOF

      - name: Set up Git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@users.noreply.github.com"

      - name: Commit files
        run: |
          git add docs/public/data/data.yaml
          git commit -m "Add new trade entry"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GH_PAT }}
          repository: 201508876PMH/hkh-trading
          force: false

  trade-block:
      needs: summary
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@master
          with:
            repository: 201508876PMH/hkh-trading
            token: ${{ secrets.GH_PAT }}

        - name: Verify confirmation
          run: |
            if [[ "${{ github.event.inputs.confirm }}" != "true" ]]; then
              echo "You must confirm all data is correct by checking the confirm box."
              exit 1
            fi

        - name: Generate journal markdown block
          id: generate_markdown
          run: |
            # Strip emojis for logic
            BIAS="${{ github.event.inputs.bias }}"
            BIAS="${BIAS//üìà/}"
            BIAS="${BIAS//üìâ/}"
            BIAS="$(echo "$BIAS" | xargs)"

            OUTCOME="${{ github.event.inputs.outcome }}"
            OUTCOME="${OUTCOME//‚úÖ/}"
            OUTCOME="${OUTCOME//‚ùå/}"
            OUTCOME="${OUTCOME//üö•/}"
            OUTCOME="$(echo "$OUTCOME" | xargs)"

            PL="${{ github.event.inputs.pl }}"
            NOTES="${{ github.event.inputs.notes }}"
            PAIR="${{ github.event.inputs.pair }}"
            DATETIME="${{ github.event.inputs.datetime }}"
            LIQUIDITY="${{ github.event.inputs.liquidity }}"
            POI="${{ github.event.inputs.poi }}"

            # Bias emoji and label
            if [ "$BIAS" = "Bullish" ]; then
              BIAS_DISPLAY="üìà Bullish"
            elif [ "$BIAS" = "Bearish" ]; then
              BIAS_DISPLAY="üìâ Bearish"
            else
              BIAS_DISPLAY="$BIAS"
            fi

            # Outcome class and label for styling
            if [ "$OUTCOME" = "Win" ]; then
              OUTCOME_CLASS="win"
              OUTCOME_LABEL="Win"
              PL_CLASS="pl-circle"
            elif [ "$OUTCOME" = "Loss" ]; then
              OUTCOME_CLASS="loss"
              OUTCOME_LABEL="Loss"
              PL_CLASS="pl-circle pl-negative"
            else
              OUTCOME_CLASS="note"
              OUTCOME_LABEL="Break-even"
              PL_CLASS="pl-circle"
            fi

            # Compose the markdown block
            cat <<EOF > journal-entry.md
            ## $DATETIME <span class="$OUTCOME_CLASS">$OUTCOME_LABEL $PL</span>
            > [!${OUTCOME_CLASS^^}] <span class="$OUTCOME_CLASS">$OUTCOME_LABEL</span>  
            > $NOTES  
            > 
            > <details open>
            > <summary>üìÇ Details</summary>
            > 
            > * **Pair**: <code>$PAIR</code>
            > * **Bias**: $BIAS_DISPLAY
            > * **Liquidity**: $LIQUIDITY
            > * **POI**: $POI
            > * **Outcome**: <span class="$OUTCOME_CLASS">$OUTCOME_LABEL</span>
            > * **P/L**: <span class="$PL_CLASS">$PL</span>
            > 
            > </details>
            > 
            > <details>
            > <summary>üìé Attachment</summary>
            > <img src="/images/ftmo-challenge-passed.png" alt="FTMO Challenge Passed" style="max-width: 300px; margin-top: 0.5rem;" />
            > </details>
            EOF

            echo "::set-output name=md_block::$(cat journal-entry.md | sed 's/%/%25/g; s/\n/%0A/g; s/\r/%0D/g')"

        - name: Append journal entry to file
          run: |
            echo -e "${{ steps.generate_markdown.outputs.md_block }}" | sed 's/%0A/\n/g; s/%0D//g; s/%25/%/g' >> docs/journal/journal.md

        - name: Set git config
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions@users.noreply.github.com"

        - name: Commit journal update
          run: |
            git add docs/journal/journal.md
            git commit -m "Add new journal entry"

        - name: Commit pull update
          run: |
            git config pull.rebase true
            git pull

        - name: Push changes
          uses: ad-m/github-push-action@master
          with:
            github_token: ${{ secrets.GH_PAT }}
            repository: 201508876PMH/hkh-trading
            force: false